<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WebAR Sketchfab with Capture</title>
  <style>
    body, html {
      margin: 0; padding: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    #cameraView {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      z-index: 1;
    }
    #modelFrame {
      position: absolute;
      top: 50%; left: 50%;
      width: 400px; height: 400px;   /* Bigger size */
      transform: translate(-50%, -50%) scale(1);
      border: none;
      z-index: 2;
      touch-action: none;
    }
    #controls {
      position: absolute;
      bottom: 10px; left: 50%;
      transform: translateX(-50%);
      z-index: 3;
      display: flex;
      gap: 10px;
      background: rgba(0,0,0,0.5);
      padding: 8px;
      border-radius: 8px;
    }
    button, select {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    #gallery {
      position: absolute;
      top: 10px; right: 10px;
      z-index: 4;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .thumb {
      width: 80px; height: 80px;
      object-fit: cover;
      border: 2px solid white;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <video id="cameraView" autoplay playsinline></video>
  <iframe id="modelFrame" allow="autoplay; fullscreen; xr-spatial-tracking"></iframe>

  <div id="controls">
    <select id="modelSelect">
      <option value="https://sketchfab.com/models/59fc99d8dcb146f3a6c16dbbcc4680da/embed?autostart=1&transparent=1">Model 1</option>
      <option value="https://sketchfab.com/models/c9de125cb9d8407abed1dc8f6a4676a8/embed?autostart=1&transparent=1">Model 2</option>
      <option value="https://sketchfab.com/models/bb6a8eeabedf49d5ad235405840ef013/embed?autostart=1&transparent=1">Model 3</option>
      <option value="https://sketchfab.com/models/54e857fc6e4944608b87e47b833843c9/embed?autostart=1&transparent=1">Model 4</option>
    </select>
    <button id="snap">üì∏ Snap</button>
    <button id="record">‚è∫Ô∏è Record</button>
    <button id="stop">‚èπÔ∏è Stop</button>
  </div>

  <div id="gallery"></div>

  <canvas id="captureCanvas" style="display:none;"></canvas>

<script>
const video = document.getElementById("cameraView");
const modelFrame = document.getElementById("modelFrame");
const modelSelect = document.getElementById("modelSelect");
const gallery = document.getElementById("gallery");
const canvas = document.getElementById("captureCanvas");
const ctx = canvas.getContext("2d");

let mediaRecorder, recordedChunks = [];

// Start camera
navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
  video.srcObject = stream;
}).catch(err => alert("Camera error: " + err));

// Load first model
modelFrame.src = modelSelect.value;
modelSelect.addEventListener("change", () => {
  modelFrame.src = modelSelect.value;
});

// Drag & pinch zoom
let scale = 1, startDist = 0, startX = 0, startY = 0, offsetX = 0, offsetY = 0;

modelFrame.addEventListener("touchstart", e => {
  if (e.touches.length === 2) {
    startDist = Math.hypot(
      e.touches[0].clientX - e.touches[1].clientX,
      e.touches[0].clientY - e.touches[1].clientY
    );
  } else if (e.touches.length === 1) {
    startX = e.touches[0].clientX - offsetX;
    startY = e.touches[0].clientY - offsetY;
  }
}, { passive: false });

modelFrame.addEventListener("touchmove", e => {
  if (e.touches.length === 2) {
    const newDist = Math.hypot(
      e.touches[0].clientX - e.touches[1].clientX,
      e.touches[0].clientY - e.touches[1].clientY
    );
    scale *= newDist / startDist;
    startDist = newDist;
  } else if (e.touches.length === 1) {
    offsetX = e.touches[0].clientX - startX;
    offsetY = e.touches[0].clientY - startY;
  }
  modelFrame.style.transform =
    `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px)) scale(${scale})`;
}, { passive: false });

// Snap picture
document.getElementById("snap").onclick = () => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  // Draw modelFrame snapshot
  html2canvas(modelFrame, { backgroundColor: null }).then(modelCanvas => {
    ctx.drawImage(modelCanvas, (canvas.width - modelFrame.offsetWidth)/2 + offsetX,
      (canvas.height - modelFrame.offsetHeight)/2 + offsetY,
      modelFrame.offsetWidth * scale,
      modelFrame.offsetHeight * scale);

    const img = document.createElement("img");
    img.src = canvas.toDataURL("image/png");
    img.className = "thumb";

    // Tap to delete
    img.onclick = () => img.remove();

    // Download link
    const link = document.createElement("a");
    link.href = img.src;
    link.download = "snapshot.png";
    link.appendChild(img);

    gallery.appendChild(link);
  });
};

// Record video
document.getElementById("record").onclick = async () => {
  const cameraStream = video.srcObject;
  const canvasStream = canvas.captureStream(30);

  // Merge streams
  const combinedStream = new MediaStream([
    ...cameraStream.getTracks(),
    ...canvasStream.getTracks()
  ]);

  mediaRecorder = new MediaRecorder(combinedStream, { mimeType: "video/webm" });
  recordedChunks = [];
  mediaRecorder.ondataavailable = e => {
    if (e.data.size > 0) recordedChunks.push(e.data);
  };
  mediaRecorder.onstop = () => {
    const blob = new Blob(recordedChunks, { type: "video/webm" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "recording.webm";
    a.textContent = "üé¨ Download Video";
    gallery.appendChild(a);
  };
  mediaRecorder.start();
};

// Stop recording
document.getElementById("stop").onclick = () => {
  if (mediaRecorder && mediaRecorder.state !== "inactive") {
    mediaRecorder.stop();
  }
};
</script>

<!-- html2canvas for snapshot overlay -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</body>
</html>
