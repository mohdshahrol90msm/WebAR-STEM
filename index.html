<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AR Snapshot with GLB Models</title>
  <style>
    body, html { margin: 0; overflow: hidden; height: 100%; background: black; }
    #ar-canvas { position: fixed; top:0; left:0; width:100%; height:100%; z-index:1; }
    #ui {
      position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 10px; z-index: 2;
    }
    button, select {
      padding: 10px; font-size: 16px; border-radius: 8px; border: none;
      background: rgba(0,0,0,0.6); color: white;
    }
  </style>
</head>
<body>
  <canvas id="ar-canvas"></canvas>
  <div id="ui">
    <select id="modelSelect">
      <option value="assets/Model 1.glb">Model 1</option>
      <option value="assets/Model 2.glb">Model 2</option>
      <option value="assets/Model 3.glb">Model 3</option>
      <option value="assets/Model 4.glb">Model 4</option>
    </select>
    <button id="snap">ðŸ“¸ Snap</button>
  </div>

  <script type="module">
    import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.157/build/three.module.js";
    import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.157/examples/jsm/loaders/GLTFLoader.js";

    const canvas = document.getElementById("ar-canvas");
    const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, preserveDrawingBuffer:true });
    renderer.setSize(window.innerWidth, window.innerHeight);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);

    // video background
    const video = document.createElement("video");
    video.autoplay = true; video.muted = true; video.playsInline = true;
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => { video.srcObject = stream; });

    const videoTexture = new THREE.VideoTexture(video);
    const videoPlane = new THREE.Mesh(
      new THREE.PlaneGeometry(2, 2),
      new THREE.MeshBasicMaterial({ map: videoTexture })
    );
    const videoScene = new THREE.Scene();
    const videoCamera = new THREE.OrthographicCamera(-1,1,1,-1,0,10);
    videoScene.add(videoPlane);

    // light
    const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
    scene.add(light);

    // load models
    const loader = new GLTFLoader();
    let currentModel;
    function loadModel(path){
      if(currentModel) scene.remove(currentModel);
      loader.load(path, gltf=>{
        currentModel = gltf.scene;
        currentModel.scale.set(0.5,0.5,0.5);
        currentModel.position.set(0,0,-2);
        scene.add(currentModel);
      });
    }
    loadModel("assets/Model 1.glb");

    document.getElementById("modelSelect").addEventListener("change", e=>{
      loadModel(e.target.value);
    });

    // touch controls for move/scale
    let lastDist=0;
    let isDragging=false, lastX=0,lastY=0;
    canvas.addEventListener("touchstart", e=>{
      if(e.touches.length===1){isDragging=true; lastX=e.touches[0].clientX; lastY=e.touches[0].clientY;}
      if(e.touches.length===2){ lastDist=Math.hypot(
        e.touches[0].clientX-e.touches[1].clientX,
        e.touches[0].clientY-e.touches[1].clientY);}
    });
    canvas.addEventListener("touchmove", e=>{
      if(currentModel){
        if(e.touches.length===1 && isDragging){
          let dx=(e.touches[0].clientX-lastX)/100;
          let dy=(e.touches[0].clientY-lastY)/100;
          currentModel.position.x += dx;
          currentModel.position.y -= dy;
          lastX=e.touches[0].clientX; lastY=e.touches[0].clientY;
        }
        if(e.touches.length===2){
          let dist=Math.hypot(
            e.touches[0].clientX-e.touches[1].clientX,
            e.touches[0].clientY-e.touches[1].clientY);
          let scale=dist/lastDist;
          currentModel.scale.multiplyScalar(scale);
          lastDist=dist;
        }
      }
    });
    canvas.addEventListener("touchend", ()=>{isDragging=false;});

    // render loop
    function render(){
      requestAnimationFrame(render);
      // draw camera feed
      renderer.autoClear=false;
      renderer.clear();
      renderer.render(videoScene, videoCamera);
      // draw 3D model
      renderer.render(scene, camera);
    }
    render();

    // snap and auto-download
    document.getElementById("snap").addEventListener("click", ()=>{
      const url=canvas.toDataURL("image/png");
      const a=document.createElement("a");
      a.href=url;
      a.download="snapshot.png";
      a.click();
    });
  </script>
</body>
</html>
